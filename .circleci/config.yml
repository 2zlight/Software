version: 2
jobs:
   build:
     docker:
       - image: circleci/python:2.7.13
     steps:
        - checkout
        - run: echo "hello world"
        - run: echo `uname -a`
        - run: cat /etc/issue
        - run:
              name: install Indigo (compatible with 14.04)
              command: |
                sudo apt-get install lsb-release
                sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
                sudo apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-key 421C365BD9FF1F717815A3895523BAEEB01FA116
                sudo apt-get update
                sudo apt-get install ros-indigo-desktop

        # Download and cache dependencies
        - restore_cache:
              keys:
              - v1-dependencies-{{ checksum "requirements.txt" }}
              # fallback to using the latest cache if no exact match is found
              - v1-dependencies-

        - run:
              name: install dependencies
              command: |
                python3 -m venv venv
                . venv/bin/activate
                pip install -r requirements.txt

        - save_cache:
              paths:
                - ./venv
              key: v1-dependencies-{{ checksum "requirements.txt" }}

        # run tests!
        - run:
              name: run tests
              command: |
                . venv/bin/activate
                python manage.py test

        - store_artifacts:
              path: test-reports
              destination: test-reports
